<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:secure-properties="http://www.mulesoft.org/schema/mule/secure-properties"
	xmlns:tls="http://www.mulesoft.org/schema/mule/tls" xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns:validation="http://www.mulesoft.org/schema/mule/validation"
	xmlns:http="http://www.mulesoft.org/schema/mule/http" xmlns:email="http://www.mulesoft.org/schema/mule/email" xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="
http://www.mulesoft.org/schema/mule/tls http://www.mulesoft.org/schema/mule/tls/current/mule-tls.xsd http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/email http://www.mulesoft.org/schema/mule/email/current/mule-email.xsd
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
http://www.mulesoft.org/schema/mule/validation http://www.mulesoft.org/schema/mule/validation/current/mule-validation.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/secure-properties http://www.mulesoft.org/schema/mule/secure-properties/current/mule-secure-properties.xsd">
	<email:smtp-config name="Email_SMTP" doc:name="Email SMTP" doc:id="efd853d1-dfcd-406e-b902-4177a6d19dbe" doc:description="Gmail connection used to send an invoice in an email" >
		<email:smtps-connection host="smtp.gmail.com" user="tmfieldtrip@gmail.com" password="${secure::emailpassword}">
			<tls:context>
	            <tls:trust-store insecure="true"/>
	        </tls:context>
		</email:smtps-connection>
	</email:smtp-config>
	<http:listener-config name="HTTP_Listener_config" doc:name="HTTP Listener config" doc:id="86051baa-7a0f-47e9-a92a-cc44bb1e6c5d" >
		<http:listener-connection host="0.0.0.0" port="8081" />
	</http:listener-config>
	<secure-properties:config name="Secure_Properties_Config" doc:name="Secure Properties Config" doc:id="24c85e9e-14fe-4eab-9e2f-0417c4575a91" file="config.yaml" key="emailpassword" />
	<flow name="sendEmail" doc:id="2bb154c9-28a5-45c3-b7e8-5e4fabf7e349" >
		<http:listener doc:name="/invoice/{department}" doc:id="ca75f5be-14ca-45b2-8f3b-51241dc33001" config-ref="HTTP_Listener_config" path="/invoice/{departmentid}" doc:description="Flow that sends out an Invoice in an email

Requires: 
{departmentid}	uri param			departmentid of the recipient (allows for custom formatting per department)
{email}				query param		recipient email address
" allowedMethods="GET" outputMimeType="application/json"/>
		<set-variable value="" doc:name="Create outputemail" doc:id="de821f4d-0bc8-4158-8675-ea2a2e1a97c9" variableName="outputemail"/>
		<set-variable value="#[attributes.uriParams.departmentid]" doc:name="Set Department ID" doc:id="399f58d7-a9b7-4988-a598-d27fe9158ffe" variableName="departmentid"/>
		<parse-template doc:name="Set email.html to outputemail" doc:id="21fcf65a-759f-4560-9528-deb5e6f0a022" location="C:\Users\RCP\git\project3-final-project\mule\src\main\resources\email.html" target="outputemail"/>
		<logger level="INFO" doc:name="Log Email Payload" doc:id="4ac71acd-af96-4016-a0d2-5afe32d961bc" message="#[payload]"/>
		<email:send doc:name="Send Email" doc:id="64bf4df8-d253-4805-89e2-681a14c48054" config-ref="Email_SMTP" fromAddress="tmfieldtrip@gmail.com" subject="Texas Mule - Invoice" doc:description="Connector that sends an invoice to an email address

Requires:
{email}				query param		sets email destination
{departmentid}	uri param			sets department destination">
			<email:to-addresses>
				<email:to-address value="#[attributes.queryParams.email]" />
			</email:to-addresses>
			<email:body contentType="text/html">
				<email:content ><![CDATA[#[vars.outputemail]]]></email:content>

			</email:body>
		</email:send>
	
</flow>
	<flow name="MuleTestEnpoint" doc:id="8c513cc9-143b-402d-b3b5-6b45b2b3e1dc" >
		<http:listener doc:name="Listener" doc:id="dec8f8dd-b95a-4347-86fd-c46204c7011d" config-ref="HTTP_Listener_config" path="/test"/>
		<set-payload value="payload has been set!" doc:name="Set Payload" doc:id="8fe2800e-241e-4e0a-9dfe-497de5337348" />
	</flow>

</mule>
